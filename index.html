<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage Handler</title>
    <style>
        button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Add User Info</h1>
    <button onclick="clearLocalStorage('source')">Clear Source </button>
    <div id="output"></div>
    <script>

        function clearLocalStorage(key){
            localStorage.removeItem(key);
        }
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function main() {
            const action = getParameterByName('action');
            const source = getParameterByName('source');
            const platform = getParameterByName('platform');
            const output = document.getElementById('output');
            const now = new Date();
            const utcDate = now.toUTCString();

            if (action === 'write') {

                let cb = (ip) => {
                    writeDataToSheet(ip, platform, utcDate, source)
                }
                getIP(cb)
            } 
            else if (action === 'read') {

            } 
            else {
                output.textContent = 'Invalid action or source parameter.';
            }
        }

        function getIP(cb){
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => { 
                    console.log('IP Address:', data.ip);
                    cb(data.ip);
                })
                .catch(error => console.error('Error fetching IP:', error));
        }

        function writeDataToSheet(key, platform, time, source) {
            fetch('https://script.google.com/macros/s/AKfycby5K0_rDhEXrLD_jj2uU6TusvkqvM-ZvB8gx1ifBaDj-w0F3DvGwCgv3MG2uJA7ym8e/exec', {
                method: 'POST',
                mode: 'cors',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'write', key: key, platform: platform, time: time, source: source })
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        main();

        
    </script>
</body>
</html>